<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [第15课-自己动手写驱动](#第15课-自己动手写驱动)
	- [编程索引](#编程索引)
	- [驱动初始化](#驱动初始化)
		- [简单内核模块模板](#简单内核模块模板)
		- [静态分配cdev](#静态分配cdev)
		- [cdev_init 初始化cdev](#cdevinit-初始化cdev)
		- [注册cdev_add](#注册cdevadd)
	- [分配设备号](#分配设备号)
	- [硬件初始化](#硬件初始化)
	- [实现设备操作](#实现设备操作)
		- [拷贝操作函数原型](#拷贝操作函数原型)
		- [open](#open)
		- [close](#close)
		- [read](#read)
		- [write](#write)
		- [lseek](#lseek)
	- [驱动注销](#驱动注销)
	- [头文件包含](#头文件包含)
	- [运行测试](#运行测试)
	- [总结](#总结)

<!-- /TOC -->

# 第15课-自己动手写驱动

## 编程索引

![1526777269635.png](image/1526777269635.png)


## 驱动初始化

###简单内核模块模板

![1526777392932.png](image/1526777392932.png)

### 静态分配cdev

      驱动初始化放在模块初始化中，静态分配、动态分配cdev
      采用静态分配，定义一个全局变量

![1526777611586.png](image/1526777611586.png)

### cdev_init 初始化cdev
      初始化cdev，拷贝函数原型，修改一下。
      定义文件操作集

![1526777597024.png](image/1526777597024.png)

![1526777643498.png](image/1526777643498.png)

![1526777718508.png](image/1526777718508.png)

### 注册cdev_add

![1526777819521.png](image/1526777819521.png)

![1526777825633.png](image/1526777825633.png)

      准备好三个参数

## 分配设备号

![1526777882114.png](image/1526777882114.png)

![1526777887578.png](image/1526777887578.png)

![1526777894183.png](image/1526777894183.png)

![1526777922992.png](image/1526777922992.png)

![1526777935079.png](image/1526777935079.png)

      设备数量定义为2

## 硬件初始化

      虚拟设备无须硬件初始化。

## 实现设备操作

### 拷贝操作函数原型

![1526778008439.png](image/1526778008439.png)

      从内核源码拷贝一波函数原型

![1526778070206.png](image/1526778070206.png)

![1526778212967.png](image/1526778212967.png)



### open

      1.硬件打开
      2.次设备号获取

![1526778278571.png](image/1526778278571.png)

      从inode提取次设备号。判断哪一个设备，获取设备基地址

![1526778335621.png](image/1526778335621.png)

![1526778370077.png](image/1526778370077.png)

### close

      close用的就是release
      玩的虚拟设备，直接return就是

![1526778450985.png](image/1526778450985.png)

### read

      获取设备基地址，然后从private_data取出
      记得还要加上偏移

![1526778531632.png](image/1526778531632.png)

![1526778521226.png](image/1526778521226.png)

![1526778581221.png](image/1526778581221.png)

      没有写参数检查。。。

![1526778643830.png](image/1526778643830.png)

### write

      写和读非常类似，拷贝过来改改

![1526778676136.png](image/1526778676136.png)

![1526778716108.png](image/1526778716108.png)

![1526778823607.png](image/1526778823607.png)

### lseek

![1526779095764.png](image/1526779095764.png)

## 驱动注销

![1526779124684.png](image/1526779124684.png)

![1526779136163.png](image/1526779136163.png)

![1526779156284.png](image/1526779156284.png)

## 头文件包含

![1526779223204.png](image/1526779223204.png)

![1526779235503.png](image/1526779235503.png)

![1526779263663.png](image/1526779263663.png)

## 运行测试

![1526779293802.png](image/1526779293802.png)

![1526779329186.png](image/1526779329186.png)

![1526779343169.png](image/1526779343169.png)

![1526779353783.png](image/1526779353783.png)

![1526779362234.png](image/1526779362234.png)

## 总结
