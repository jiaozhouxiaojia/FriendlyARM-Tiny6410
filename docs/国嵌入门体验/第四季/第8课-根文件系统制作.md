<!-- TOC depthFrom:1 depthTo:6 withLinks:1 updateOnSave:1 orderedList:0 -->

- [第8课-根文件系统制作](#第8课-根文件系统制作)
	- [嵌入式系统构成](#嵌入式系统构成)
	- [课程索引](#课程索引)
	- [建立根文件系统目录与文件](#建立根文件系统目录与文件)
		- [创建目录](#创建目录)
		- [创建设备文件](#创建设备文件)
		- [加入配置文件](#加入配置文件)
		- [添加内核模块](#添加内核模块)
		- [编译busybox](#编译busybox)
	- [挂载根文件系统到内核](#挂载根文件系统到内核)
		- [文件系统类型](#文件系统类型)
		- [使用initramfs挂载](#使用initramfs挂载)
		- [NFS挂载](#nfs挂载)
	- [总结](#总结)

<!-- /TOC -->

# 第8课-根文件系统制作

## 嵌入式系统构成

![1526610964345.png](image/1526610964345.png)

      根文件系统
        根：指的就是第一个文件系统，Linux可以包含多种文件系统，但是第一个必须得有，不然内核没办法启动
        文件系统：EXT系列，btfs、FAT、NTFS

![1526611152708.png](image/1526611152708.png)

      目录及目录下的所有文件即为文件系统表象

## 课程索引

![1526611126527.png](image/1526611126527.png)

## 建立根文件系统目录与文件

### 创建目录

![1526612275307.png](image/1526612275307.png)

![1526612337930.png](image/1526612337930.png)

### 创建设备文件

      什么是设备文件？
      Linux绝大部分设备会以设备文件的形式存在。操作设备就是对设备增删改查。

![1526612392779.png](image/1526612392779.png)

      mknod 怎么玩儿？？

![1526612476531.png](image/1526612476531.png)

### 加入配置文件

![1526612410579.png](image/1526612410579.png)

![1526612516450.png](image/1526612516450.png)

![1526612551225.png](image/1526612551225.png)

![1526612577467.png](image/1526612577467.png)





### 添加内核模块

![1526612647000.png](image/1526612647000.png)

![1526612690556.png](image/1526612690556.png)

      编译内核模块之后模块是散落在各个子目录当中的。
      需要先安装模块/lib/modules/`uname -r`
      指定安装路径，给出根路径即可

![1526612784041.png](image/1526612784041.png)

![1526612844645.png](image/1526612844645.png)


### 编译busybox

      busybox - 嵌入式开发中的瑞士军刀

![1526612894037.png](image/1526612894037.png)

![1526612899736.png](image/1526612899736.png)

![1526612971406.png](image/1526612971406.png)

![1526612982377.png](image/1526612982377.png)

      必须使用静态

![1526613007212.png](image/1526613007212.png)

      必须指定交叉编译

![1526613028418.png](image/1526613028418.png)

![1526613040383.png](image/1526613040383.png)

      指定安装路径

![1526613088728.png](image/1526613088728.png)

![1526613122927.png](image/1526613122927.png)

      make 编译

![1526613222497.png](image/1526613222497.png)

      make install安装，实际上就是拷贝过程

![1526613265501.png](image/1526613265501.png)

![1526613280161.png](image/1526613280161.png)

## 挂载根文件系统到内核

      Linux系统如何使用这些目录文件？
        选择何种文件系统？

![1526612907593.png](image/1526612907593.png)

![1526613326738.png](image/1526613326738.png)

### 文件系统类型

![1526613408472.png](image/1526613408472.png)

      yaffs2 UbiFS 可读写
      clanfs 只读
      Jffs2 可读写
      内存文件系统中Ramdidsk比较老，将内存模拟成磁盘。
      Ramdisk：划分大小固定，超过无法处理，内存空间浪费
      Initramfs：事先不用指定大小，可以动态扩展。
        启动速度块。性能更好，多使用它。只能上电状态维持。
        因此需要增加一个存储设备的文件系统。有的目录用initramfs，有的目录用存储设备文件系统。
      网络文件系统nfs：主要是在开发阶段使用

### 使用initramfs挂载

      必须先创建一个软链接

![1526617982329.png](image/1526617982329.png)

![1526618609703.png](image/1526618609703.png)

![1526618654727.png](image/1526618654727.png)

![1526618675288.png](image/1526618675288.png)

      勾选，设置路径

![1526618686375.png](image/1526618686375.png)

![1526618735104.png](image/1526618735104.png)

      重新编译内核

![1526618793063.png](image/1526618793063.png)

![1526618825635.png](image/1526618825635.png)

      进入UBoot设置环境变量

![1526618911687.png](image/1526618911687.png)

![1526618958585.png](image/1526618958585.png)

      即可启动内核

![1526619017282.png](image/1526619017282.png)


### NFS挂载

      initramfs是在开发板内存中，如果想要读写该文件系统就要全部重做镜像。这很麻烦。
      先要在rootfs中添加好，然后重新编译内核。
      uImage包含两个部分，一个部分是内核，另一个部分是initramfs。
      如果要频繁更改其内容，过程太繁琐。因此有了NFS挂载

![1526619200660.png](image/1526619200660.png)

![1526619256074.png](image/1526619256074.png)

      首先内核配置开启该选项

![1526619296766.png](image/1526619296766.png)

      去掉initramfs配置。然后进入filesystem选项

![1526619322818.png](image/1526619322818.png)

![1526619345222.png](image/1526619345222.png)

![1526619359630.png](image/1526619359630.png)

![1526619378838.png](image/1526619378838.png)

![1526619450210.png](image/1526619450210.png)

![1526619462249.png](image/1526619462249.png)

      配置启动参数，参数是针对UBoot，并且可以存储在NandFlash中的固定位置。

![1526619507973.png](image/1526619507973.png)

      off：关闭dhcp

![1526619728415.png](image/1526619728415.png)

      启动前确保nfs启动

![1526619747753.png](image/1526619747753.png)

![1526619755390.png](image/1526619755390.png)

![1526619772927.png](image/1526619772927.png)

![1526619797917.png](image/1526619797917.png)

![1526619819395.png](image/1526619819395.png)

![1526619826379.png](image/1526619826379.png)

      宿主机增上改查文件，立马在开发板中起效。

![1526619868677.png](image/1526619868677.png)

      做成产品时，不会用到。nfs只会在开发阶段使用。而initramfs是在产品中使用。


## 总结
